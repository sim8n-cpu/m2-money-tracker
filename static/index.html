<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M2 Money Supply Tracker | Global Economic Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #12182b;
            --bg-card: #1a2342;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --accent-primary: #00d4ff;
            --accent-secondary: #7b68ee;
            --border-color: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        header {
            background: var(--bg-secondary);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: 1.75rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .country-selector {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .selector-title {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .country-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .country-checkbox {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
        }

        .country-checkbox:hover {
            border-color: var(--accent-primary);
        }

        .country-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary);
        }

        .country-info {
            display: flex;
            flex-direction: column;
        }

        .country-name {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .country-currency {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .chart-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .update-time {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 1rem;
        }

        .sources-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .sources-title {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .sources-list {
            list-style: none;
        }

        .source-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .source-item:last-child {
            border-bottom: none;
        }

        .source-link {
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: 500;
        }

        .source-link:hover {
            text-decoration: underline;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .disclaimer {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            border-left: 3px solid var(--accent-secondary);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .country-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .chart-wrapper {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div>
                <h1>M2 Money Supply Tracker</h1>
                <div class="subtitle">Compare broad money supply across major economies</div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="country-selector">
            <div class="selector-title">Select countries to compare:</div>
            <div class="country-grid" id="countryGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">M2 Money Supply Over Time</div>
            <div class="chart-wrapper">
                <canvas id="m2Chart"></canvas>
            </div>
            <div class="update-time" id="updateTime">-</div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Latest M2 Values (Normalized)</div>
            <div class="chart-wrapper">
                <canvas id="latestChart"></canvas>
            </div>
        </div>

        <div class="sources-section">
            <div class="sources-title">Data Sources</div>
            <ul class="sources-list" id="sourcesList">
                <li class="source-item">
                    <span>üá∫üá∏</span>
                    <span>Federal Reserve - M2 Money Stock</span>
                    <a href="https://fred.stlouisfed.org/series/M2SL" target="_blank" class="source-link">View Source ‚Üí</a>
                </li>
                <li class="source-item">
                    <span>üá™üá∫</span>
                    <span>European Central Bank - M2 for Euro Area</span>
                    <a href="https://www.ecb.europa.eu/stats/money/aggregates/ecb_definitions/en/html/index.en.html" target="_blank" class="source-link">View Source ‚Üí</a>
                </li>
                <li class="source-item">
                    <span>üá®üá≥</span>
                    <span>People's Bank of China - Money Supply Statistics</span>
                    <a href="http://www.pbc.gov.cn/en/3688110/3688172/index.html" target="_blank" class="source-link">View Source ‚Üí</a>
                </li>
                <li class="source-item">
                    <span>üáØüáµ</span>
                    <span>Bank of Japan - Money Stock</span>
                    <a href="https://www.boj.or.jp/en/statistics/ms/ms.htm" target="_blank" class="source-link">View Source ‚Üí</a>
                </li>
                <li class="source-item">
                    <span>üá¨üáß</span>
                    <span>Bank of England - M2 Money Supply</span>
                    <a href="https://www.bankofengland.co.uk/statistics" target="_blank" class="source-link">View Source ‚Üí</a>
                </li>
                <li class="source-item">
                    <span>üåç</span>
                    <span>World Bank - Money Supply Data</span>
                    <a href="https://data.worldbank.org/indicator/FM.LBL.MQMY.CN" target="_blank" class="source-link">View Source ‚Üí</a>
                </li>
            </ul>
            <div class="disclaimer">
                <strong>Disclaimer:</strong> Data shown is approximate and based on historical records from public sources. 
                Different countries define and measure M2 differently. For precise comparisons, consider exchange rates and 
                purchasing power parity. This tool is for educational purposes only.
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.pathname === '/' ? '/api' : './api';
        let m2Chart = null;
        let latestChart = null;
        let availableCountries = [];
        let selectedCountries = ['US', 'CN'];

        const countryColors = {
            'US': '#00d4ff',
            'CN': '#ff6b6b',
            'EU': '#7b68ee',
            'JP': '#4ecdc4',
            'GB': '#ff9f43'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCountries();
            await loadData();
        });

        async function loadCountries() {
            try {
                const response = await fetch(`${API_BASE}/countries`);
                const data = await response.json();
                availableCountries = data.countries;
                renderCountrySelector();
            } catch (error) {
                console.error('Error loading countries:', error);
                document.getElementById('countryGrid').innerHTML = 
                    '<p style="color: #ff6b6b;">Error loading countries. Please refresh.</p>';
            }
        }

        function renderCountrySelector() {
            const grid = document.getElementById('countryGrid');
            grid.innerHTML = availableCountries.map(country => `
                <label class="country-checkbox">
                    <input type="checkbox" 
                           value="${country.code}" 
                           ${selectedCountries.includes(country.code) ? 'checked' : ''}
                           onchange="toggleCountry('${country.code}', this.checked)">
                    <div class="country-info">
                        <span class="country-name">${country.name}</span>
                        <span class="country-currency">${country.currency} ‚Ä¢ ${country.unit}</span>
                    </div>
                </label>
            `).join('');
        }

        function toggleCountry(code, isChecked) {
            if (isChecked) {
                if (!selectedCountries.includes(code)) {
                    selectedCountries.push(code);
                }
            } else {
                selectedCountries = selectedCountries.filter(c => c !== code);
            }
            loadData();
        }

        async function loadData() {
            if (selectedCountries.length === 0) {
                selectedCountries = ['US'];
            }

            try {
                const response = await fetch(
                    `${API_BASE}/m2?countries=${selectedCountries.join(',')}`
                );
                const data = await response.json();
                
                document.getElementById('updateTime').textContent = 
                    `Last updated: ${new Date(data.lastUpdated).toLocaleString()}`;
                
                renderCharts(data.countries);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function renderCharts(countriesData) {
            const ctx = document.getElementById('m2Chart').getContext('2d');
            const ctx2 = document.getElementById('latestChart').getContext('2d');

            // Prepare datasets for time series
            const datasets = Object.entries(countriesData).map(([code, info]) => {
                const dates = info.data.map(d => d.date);
                const values = info.data.map(d => d.value);
                
                return {
                    label: `${info.name} (${info.currency})`,
                    data: values,
                    borderColor: countryColors[code] || '#999',
                    backgroundColor: countryColors[code] + '20' || '#99999920',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    borderWidth: 2,
                    dates: dates
                };
            });

            // Destroy existing charts
            if (m2Chart) m2Chart.destroy();
            if (latestChart) latestChart.destroy();

            // Time series chart
            m2Chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: datasets[0]?.dates || [],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#fff',
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#333',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const code = Object.keys(countriesData)[context.datasetIndex];
                                    const unit = countriesData[code].unit;
                                    const value = context.parsed.y;
                                    return `${context.dataset.label}: ${value.toLocaleString()} ${unit.split(' ')[1]}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#2d3748'
                            },
                            ticks: {
                                color: '#a0aec0'
                            }
                        },
                        y: {
                            grid: {
                                color: '#2d3748'
                            },
                            ticks: {
                                color: '#a0aec0'
                            },
                            title: {
                                display: true,
                                text: 'Money Supply (Local Currency)',
                                color: '#a0aec0'
                            }
                        }
                    }
                }
            });

            // Latest values comparison (bar chart)
            const latestData = Object.entries(countriesData).map(([code, info]) => {
                const latest = info.data[info.data.length - 1];
                return {
                    country: info.name,
                    value: latest.value,
                    unit: info.unit,
                    code: code
                };
            });

            latestChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: latestData.map(d => d.country),
                    datasets: [{
                        label: 'Latest M2 Value',
                        data: latestData.map(d => d.value),
                        backgroundColor: latestData.map(d => countryColors[d.code] + '80' || '#99999980'),
                        borderColor: latestData.map(d => countryColors[d.code] || '#999'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#333',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const data = latestData[context.dataIndex];
                                    return `${data.value.toLocaleString()} ${data.unit}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#fff'
                            }
                        },
                        y: {
                            grid: {
                                color: '#2d3748'
                            },
                            ticks: {
                                color: '#a0aec0'
                            },
                            title: {
                                display: true,
                                text: 'Money Supply (Local Currency Units)',
                                color: '#a0aec0'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
